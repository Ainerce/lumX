#!/bin/bash

BOLD=""
UNDERLINE=""
STANDOUT=""
DEFAULT=""
BLACK=""
RED=""
GREEN=""
YELLOW=""
BLUE=""
MAGENTA=""
CYAN=""
WHITE=""

# Check if stdout is a terminal...
if test -t 1; then

    # See if it supports colors...
    ncolors=$(tput colors)

    if test -n "$ncolors" && test $ncolors -ge 8; then
        BOLD="$(tput bold)"
        UNDERLINE="$(tput smul)"
        STANDOUT="$(tput smso)"
        DEFAULT="$(tput sgr0)"
        BLACK="$(tput setaf 0)"
        RED="$(tput setaf 1)"
        GREEN="$(tput setaf 2)"
        YELLOW="$(tput setaf 3)"
        BLUE="$(tput setaf 4)"
        MAGENTA="$(tput setaf 5)"
        CYAN="$(tput setaf 6)"
        WHITE="$(tput setaf 7)"
    fi
fi


PYFILES=$(git diff --cached --name-only --diff-filter=ACM | grep ".py$")
printf "Checking ${BOLD}Python${DEFAULT} files with ${BLUE}FLAKE8${DEFAULT}......... "
if [ "$PYFILES" != "" ]; then
    flake8 ${PYFILES}
    if [[ "$?" = "0" ]]; then
        printf "${GREEN}✔ SUCCESS${DEFAULT}\n"
    else
        printf "${RED}❌ FAIL${DEFAULT}\n"
        exit 1
    fi
else
    printf "${CYAN}DONE${DEFAULT}\n"
fi


TSFILES=$(git diff --cached --name-only --diff-filter=ACM | grep ".ts$")
printf "Checking ${BOLD}Typescript${DEFAULT} files with ${BLUE}TSLint${DEFAULT}..... "
if [ "$TSFILES" != "" ]; then
    exit_code=0

    touch /tmp/tslint-result.log

    node_modules/tslint/bin/tslint -t stylish -o /tmp/tslint-result.log ${TSFILES}

    TSLINT_FAILS=$(cat /tmp/tslint-result.log | grep "warning|error")
    if [[ $TSLINT_FAILS != "" ]]; then
        printf "${RED}FAILED${DEFAULT}"
        printf "\n\n===== TSLint logs =====\n"
        cat /tmp/tslint-result.log

        exit_code=1
    else
        printf "${GREEN}SUCCESS${DEFAULT}\n"
    fi

    rm /tmp/tslint-result.log

    exit $exit_code
else
    printf "${CYAN}DONE${DEFAULT}\n"
fi


JSFILES=$(git diff --cached --name-only --diff-filter=ACM | grep ".js$")
printf "Checking ${BOLD}Javascript${DEFAULT} files with ${BLUE}ESLint${DEFAULT}..... "
if [ "$JSFILES" != "" ]; then
    exit_code=0

    touch /tmp/eslint-result.log

    node_modules/eslint/bin/eslint.js -f stylish -o /tmp/eslint-result.log ${JSFILES}

    ESLINT_FAILS=$(cat /tmp/eslint-result.log | grep "warning|error")
    if [[ $ESLINT_FAILS != "" ]]; then
        printf "${RED}FAILED${DEFAULT}"
        printf "\n\n===== ESLint logs =====\n"
        cat /tmp/eslint-result.log

        exit_code=1
    else
        printf "${GREEN}SUCCESS${DEFAULT}\n"
    fi

    rm /tmp/eslint-result.log

    exit $exit_code
else
    printf "${CYAN}DONE${DEFAULT}\n"
fi


SASSFILES=$(git diff --cached --name-only --diff-filter=ACM | grep ".scss$")
printf "Checking ${BOLD}SASS${DEFAULT} files with ${BLUE}SASS-Lint${DEFAULT}........ "
if [ "$SASSFILES" != "" ]; then
    exit_code=0

    touch /tmp/sasslint-result.log

    ./node_modules/sass-lint/bin/sass-lint.js -t stylish -q -o /tmp/sasslint-result.log ${SASSFILES}

    SASSLINT_FAILS=$(cat /tmp/sasslint-result.log | grep "warning|error")
    if [[ $SASSLINT_FAILS != "" ]]; then
        printf "${RED}❌ FAILED${DEFAULT}"

        if [[ $SASSLINT_FAILS != "" ]]; then
            printf "\n\n===== SASS-Lint logs =====\n"
            cat /tmp/sasslint-result.log

            exit_code=1
        fi
    else
        printf "${GREEN}✔ SUCCESS${DEFAULT}\n"
    fi

    rm /tmp/sasslint-result.log

    exit $exit_code
else
    printf "${CYAN}DONE${DEFAULT}\n"
fi

printf "\n"

exit 0
