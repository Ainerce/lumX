#!/bin/bash

RED="\e[31m"
GREEN="\e[32m"
BLUE="\e[34m"
DEFAULT="\e[39m"


function display_tslint_logs() {
    while read -r line; do
        filename=`echo ${line} | cut -d'[' -f 1 | xargs`

        next=`echo ${line} | cut -d'[' -f 2 | xargs`
        line_col=`echo ${next} | cut -d']' -f 1 | xargs`

        line_number=`echo ${line_col} | cut -d',' -f 1 | xargs`
        col_number=`echo ${line_col} | cut -d',' -f 2 | xargs`

        error=`echo ${next} | cut -d':' -f 2 | xargs`

        if [[ "$filename" != "$next" ]]; then
            printf "${filename}@${line_number}:${col_number}\n"
            printf "\t${RED}$error${DEFAULT}\n"
        fi
    done < "$1"
}


PYFILES=$(git diff --cached --name-only --diff-filter=ACM | grep ".py$")
if [ "$PYFILES" != "" ]; then
    printf "Launching PEP8................ "
    pep8 ${PYFILES} --max-line-length=120 --ignore=E402 --exclude=strings.py
    if [[ "$?" = "0" ]]; then
        printf "${GREEN}SUCCESS${DEFAULT}\n"
    else
        printf "${RED}FAILED${DEFAULT}\n"
        exit 1
    fi

    printf "Launching pyflakes............ "
    pyflakes ${PYFILES}
    if [[ "$?" = "0" ]]; then
        printf "${GREEN}SUCCESS${DEFAULT}\n"
    else
        printf "${RED}FAILED${DEFAULT}"
        exit 1
    fi
else
    printf "${BLUE}No Python files to check${DEFAULT}\n"
fi


TSFILES=$(git diff --cached --name-only --diff-filter=ACM | grep ".ts$")
if [ "$TSFILES" != "" ]; then
    exit_code=0

    printf "Launching TSLint..... "
    touch /tmp/tslint-result.log

    node_modules/tslint/bin/tslint -t stylish -o ${TSFILES}

    TSLINT_FAILS=$(cat /tmp/tslint-result.log | grep "warning|error")
    if [[ $TSLINT_FAILS != "" ]]; then
        printf "${RED}FAILED${DEFAULT}"
        printf "\n\n===== TSLint logs =====\n"
        cat /tmp/tslint-result.log

        exit_code=1
    else
        printf "${GREEN}SUCCESS${DEFAULT}\n"
    fi

    rm /tmp/tslint-result.log

    exit $exit_code
fi


JSFILES=$(git diff --cached --name-only --diff-filter=ACM | grep ".js$")
if [ "$JSFILES" != "" ]; then
    exit_code=0

    printf "Launching ESLint..... "
    touch /tmp/eslint-result.log

    node_modules/eslint/bin/eslint -t stylish -o ${JSFILES}

    ESLINT_FAILS=$(cat /tmp/eslint-result.log | grep "warning|error")
    if [[ $ESLINT_FAILS != "" ]]; then
        printf "${RED}FAILED${DEFAULT}"
        printf "\n\n===== ESLint logs =====\n"
        cat /tmp/eslint-result.log

        exit_code=1
    else
        printf "${GREEN}SUCCESS${DEFAULT}\n"
    fi

    rm /tmp/eslint-result.log

    exit $exit_code
fi


SASSFILES=$(git diff --cached --name-only --diff-filter=ACM | grep ".scss$")
if [ "$SASSFILES" != "" ]; then
    exit_code=0

    printf "${GRAY}Launching ${BLUE}SASS-Lint${DEFAULT}..... "
    touch /tmp/sasslint-result.log

    ./node_modules/sass-lint/bin/sass-lint.js ${SASSFILES} -t stylish -q -o /tmp/sasslint-result.log

    SASSLINT_FAILS=$(cat /tmp/sasslint-result.log | grep "warning|error")
    if [[ $SASSLINT_FAILS != "" ]]; then
        printf "${RED}❌ FAILED${DEFAULT}"

        if [[ $SASSLINT_FAILS != "" ]]; then
            printf "\n\n===== SASS-Lint logs =====\n"
            cat /tmp/sasslint-result.log

            exit_code=1
        fi
    else
        printf "${GREEN}✔ SUCCESS${DEFAULT}\n"
    fi

    rm /tmp/sasslint-result.log

    exit $exit_code
fi


exit 0
